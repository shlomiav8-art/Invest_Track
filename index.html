<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>InvestTrack â€“ ×ª×™×§ ×”×©×§×¢×•×ª ××™×©×™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- iOS standalone -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="InvestTrack" />
  <meta name="theme-color" content="#0b1220" />

  <!-- Chart.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-main: #0b1220;
      --bg-card: #111827;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #22c55e;
      --danger: #f97373;
      --primary: #22c55e;
      --tab-border: #1f2937;
    }
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: radial-gradient(circle at top left, #1f2937, #020617 55%); color: var(--text-main); }
    header {
      background: linear-gradient(135deg, #0f172a, #020617);
      color: #f9fafb;
      padding: 14px 16px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }
    .header-left { display: flex; align-items: center; gap: 10px; }
    .logo-circle {
      width: 32px; height: 32px; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #4ade80, #22c55e 40%, #16a34a 70%, #14532d 100%);
      display: flex; align-items: center; justify-content: center;
      color: #e5fdf5; font-size: 18px; font-weight: 700;
      box-shadow: 0 0 24px rgba(34, 197, 94, 0.7);
    }
    .header-titles { display:flex; flex-direction:column; }
    .app-name { font-weight:600; font-size:16px; }
    .app-subtitle { font-size:11px; color:#9ca3af; }
    .header-actions { display:flex; align-items:center; gap:8px; }

    .btn {
      padding: 8px 14px; border-radius: 999px; border: none;
      font-size: 13px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .btn-primary { background: var(--accent); color: #022c22; font-weight: 600; box-shadow: 0 0 18px rgba(34, 197, 94, 0.4); }
    .btn-ghost { background: rgba(15, 23, 42, 0.9); color: var(--text-muted); border: 1px solid rgba(148, 163, 184, 0.4); }
    .btn-secondary { background: #1f2937; color: #e5e7eb; border: 1px solid #374151; }
    .btn-danger { background: #7f1d1d; color: #fee2e2; border: 1px solid #b91c1c; }
    .btn-small { padding: 4px 8px; font-size: 11px; border-radius: 999px; }
    .btn:disabled { opacity:.5; cursor:default; box-shadow:none; }

    .icon-circle {
      width: 18px; height: 18px; border-radius: 999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:11px; background: rgba(15,23,42,0.9); color: var(--accent);
    }

    .container { padding: 12px 10px 18px; max-width: 960px; margin: 0 auto; }

    /* Error bar */
    .error-bar {
      display:none;
      margin: 10px 10px 0;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(127, 29, 29, 0.55);
      border: 1px solid rgba(185, 28, 28, 0.8);
      color: #fee2e2;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .error-bar.show { display:block; }

    .tabs {
      display:flex; border-radius:999px; background: rgba(15,23,42,0.9);
      padding:3px; border:1px solid var(--tab-border); margin-bottom:12px;
    }
    .tab {
      flex:1; padding:7px 10px; text-align:center; font-size:13px;
      cursor:pointer; border-radius:999px; color:#9ca3af; transition: all .15s;
    }
    .tab.active { font-weight:600; background:#020617; color:#e5e7eb; box-shadow:0 0 12px rgba(15,23,42,0.9); }

    .screen { display:none; margin-top:8px; }
    .screen.active { display:block; }

    .dashboard-grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-bottom:12px; }
    @media(min-width:720px){ .dashboard-grid { grid-template-columns:repeat(4,minmax(0,1fr)); } }

    .card {
      background: rgba(15,23,42,0.96);
      border-radius:16px;
      padding:10px 11px;
      margin-bottom:10px;
      box-shadow:0 10px 40px rgba(15,23,42,0.7);
      border:1px solid rgba(55,65,81,0.7);
    }

    .card-title-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .card-title { font-weight:500; font-size:13px; color:#d1d5db; }
    .card-subtitle { font-size:11px; color:var(--text-muted); margin-bottom:4px; }

    .metric-label { font-size:11px; color:var(--text-muted); }
    .metric-value { font-size:16px; font-weight:600; margin-top:4px; }
    .metric-positive { color:#4ade80; }
    .metric-negative { color:#fca5a5; }
    .metric-neutral { color:#e5e7eb; }

    .badge-icon {
      width:34px; height:34px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:18px; background: rgba(15,23,42,0.9); color:#f9fafb;
    }
    .badge-icon.money { border:1px solid rgba(52,211,153,0.8); color:#bbf7d0; }
    .badge-icon.savings { border:1px solid rgba(250,204,21,0.9); color:#facc15; }
    .badge-icon.trend { border:1px solid rgba(52,211,153,0.7); color:#6ee7b7; }
    .badge-icon.xirr { border:1px solid rgba(96,165,250,0.7); color:#bfdbfe; }
    .badge-icon.tax { border:1px solid rgba(239,68,68,0.7); color:#fecaca; }

    .section-title {
      font-size:13px; font-weight:500; margin:4px 2px 6px; color:#e5e7eb;
      display:flex; align-items:center; gap:6px;
    }
    .section-title span.icon {
      width:18px; height:18px; border-radius:999px; background:#0f172a;
      display:inline-flex; align-items:center; justify-content:center; font-size:11px; color:#38bdf8;
    }

    label { font-size:12px; color:var(--text-muted); }
    input, select, textarea {
      width:100%; padding:7px 9px; margin:4px 0 8px;
      border-radius:10px; border:1px solid var(--border-subtle);
      font-size:13px; background:#020617; color:var(--text-main); outline:none;
    }
    input::placeholder, textarea::placeholder { color:#6b7280; }
    input:focus, select:focus, textarea:focus { border-color:#38bdf8; box-shadow:0 0 0 1px rgba(56,189,248,0.5); }

    table { width:100%; border-collapse:collapse; font-size:12px; margin-top:4px; }
    th, td { padding:5px 4px; border-bottom:1px solid rgba(31,41,55,0.9); text-align:center; color:#e5e7eb; }
    th {
      background:#020617; font-weight:500; font-size:11px; color:#9ca3af;
      position:sticky; top:0; z-index:1;
    }
    tr:nth-child(even) td { background:rgba(15,23,42,0.8); }

    .small { font-size:11px; color:var(--text-muted); }
    .flex-row { display:flex; gap:6px; }
    .flex-1 { flex:1; }
    canvas { max-width:100%; }

    .tag {
      display:inline-block; padding:2px 6px; border-radius:999px;
      background:rgba(15,23,42,0.85); color:#93c5fd; font-size:11px;
      margin-left:4px; border:1px solid rgba(37,99,235,0.6);
    }

    .checkbox-row { display:flex; align-items:flex-start; gap:8px; margin-top:8px; font-size:12px; color:var(--text-muted); }
    .checkbox-row input[type="checkbox"] { width:auto; margin-top:3px; }

    .pill {
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px; border-radius:999px;
      background:rgba(15,23,42,0.9); border:1px solid rgba(55,65,81,0.9);
      font-size:11px; color:#9ca3af;
    }

    .edit-indicator { display:none; margin-top:4px; font-size:11px; color:#facc15; }
    .edit-indicator.active { display:flex; align-items:center; gap:6px; }

    /* Progress bar */
    .progress-wrap {
      display:none;
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.9);
      background: rgba(2,6,23,0.65);
    }
    .progress-wrap.show { display:block; }
    .progress-top { display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:8px; }
    .progress-text { font-size:12px; color: var(--text-muted); }
    .progress-track {
      width:100%;
      height:10px;
      border-radius:999px;
      background: rgba(31,41,55,0.9);
      overflow:hidden;
      border:1px solid rgba(55,65,81,0.9);
    }
    .progress-bar {
      height:100%;
      width:0%;
      border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 16px rgba(34,197,94,0.35);
      transition: width .2s ease;
    }

    /* Chart legend */
    .legend-wrap {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 10px;
    }
    @media(min-width:720px){
      .legend-wrap { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .legend-item {
      display:flex; align-items:center; gap:8px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid rgba(55,65,81,0.8);
      background: rgba(2,6,23,0.35);
      font-size: 11px;
      color: #e5e7eb;
    }
    .legend-swatch {
      width: 10px; height: 10px; border-radius: 3px;
      flex: 0 0 auto;
    }
    .legend-text { display:flex; flex-direction:column; gap:2px; min-width:0; }
    .legend-text .t1 { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .legend-text .t2 { color: var(--text-muted); }
  </style>
</head>

<body>
<div id="errorBar" class="error-bar"></div>

<header>
  <div class="header-left">
    <div class="logo-circle">â‚®</div>
    <div class="header-titles">
      <div class="app-name">InvestTrack</div>
      <div class="app-subtitle">Portfolio Manager â€¢ Local Only</div>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn btn-ghost" id="btnExportTop">
      <span class="icon-circle">â‡©</span> ×’×™×‘×•×™
    </button>
    <button class="btn btn-primary" id="btnAddInvestmentTop">
      <span class="icon-circle">ï¼‹</span> ×”×•×¡×£ ×¢×¡×§×”
    </button>
  </div>
</header>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-screen="portfolio">×ª×™×§</div>
    <div class="tab" data-screen="trades">×¢×¡×§××•×ª</div>
    <div class="tab" data-screen="dividends">×“×™×‘×™×“× ×“×™×</div>
    <div class="tab" data-screen="settings">×”×’×“×¨×•×ª</div>
  </div>

  <!-- PORTFOLIO -->
  <div class="screen active" id="screen-portfolio">
    <div class="dashboard-grid">
      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="metric-label">Total Value</div>
            <div class="metric-value metric-neutral" id="portfolioValue"></div>
          </div>
          <div class="badge-icon money">ğŸ’¹</div>
        </div>
        <div class="small">×©×•×•×™ ×©×•×§ × ×•×›×—×™ (××¡ ×¨×•×•×— ×”×•×Ÿ ×—×œ ×¨×§ ×‘××™××•×©).</div>
      </div>

      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="metric-label">Total Invested</div>
            <div class="metric-value metric-neutral" id="portfolioInvested"></div>
          </div>
          <div class="badge-icon savings">ğŸ’°</div>
        </div>
        <div class="small">×¡×š ×§× ×™×•×ª (×‘×¨×•×˜×•, ×›×•×œ×œ ×¢××œ×•×ª).</div>
      </div>

      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="metric-label">Total Gain / Loss</div>
            <div class="metric-value" id="portfolioPL"></div>
          </div>
          <div class="badge-icon trend">ğŸ“ˆ</div>
        </div>
        <div class="small">× ×˜×• ××—×¨×™ ××¡: <b><span id="portfolioPLNet"></span></b></div>
      </div>

      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="metric-label">Return &amp; XIRR</div>
            <div class="metric-value" id="portfolioReturn"></div>
          </div>
          <div class="badge-icon xirr">ğ‘Ÿ</div>
        </div>
        <div class="small">XIRR (Gross): <span id="portfolioXirr"></span></div>
        <div class="small">XIRR (Net): <b><span id="portfolioXirrNet"></span></b></div>
      </div>

      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="metric-label">Total Dividends</div>
            <div class="metric-value metric-positive" id="portfolioDividends"></div>
          </div>
          <div class="badge-icon savings">ğŸ’µ</div>
        </div>
        <div class="small">× ×˜×• ××—×¨×™ ××¡: <b><span id="portfolioDividendsNet"></span></b></div>
      </div>

      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="metric-label">Estimated Taxes</div>
            <div class="metric-value" id="portfolioTaxes"></div>
          </div>
          <div class="badge-icon tax">ğŸ§¾</div>
        </div>
        <div class="small">××¡ ×¢×œ ×¨×•×•×—×™ ×”×•×Ÿ ×××•××©×™× + ××¡ ××©×•×¢×¨ ×¢×œ ×“×™×‘×™×“× ×“×™×/×§×•×¤×•× ×™×.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title-row">
        <div class="card-title">Portfolio Overview</div>
        <span class="pill">Base Currency: <span id="baseCurrencyLabel"></span></span>
      </div>
      <div class="card-subtitle">
        ××—×•×©×‘ ×œ×¤×™ ×›×œ ×”×¢×¡×§××•×ª ×•×”×“×™×‘×™×“× ×“×™× ×‘×ª×•×¡×¤×ª ×©×•×•×™ ×©×•×§ × ×•×›×—×™ ×©×œ ×”×¤×•×–×™×¦×™×•×ª.
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
        <button class="btn btn-secondary" id="btnRecalc">×¨×¢× ×Ÿ ×—×™×©×•×‘×™×</button>
        <button class="btn btn-secondary" id="btnUpdatePrices">×¢×“×›×Ÿ ××—×™×¨×™ ×©×•×§ (Alpha Vantage)</button>
      </div>

      <!-- Progress UI -->
      <div id="quoteProgressWrap" class="progress-wrap">
        <div class="progress-top">
          <div class="progress-text" id="quoteProgressText">××¢×“×›×Ÿâ€¦</div>
          <div class="progress-text" id="quoteProgressPct">0%</div>
        </div>
        <div class="progress-track"><div class="progress-bar" id="quoteProgressBar"></div></div>
        <div class="small" style="margin-top:6px;">
          Alpha Vantage ××’×‘×™×œ ×œÖ¾5 ×§×¨×™××•×ª ×‘×“×§×”. ×”××¤×œ×™×§×¦×™×” ×××ª×™× ×” ××•×˜×•××˜×™×ª ×‘×™×Ÿ ×¡×™××•×œ×™×.
        </div>
      </div>

      <div class="small" id="onlineQuotesStatus" style="margin-top:6px;"></div>
    </div>

    <!-- Manual price update -->
    <div class="section-title"><span class="icon">âœï¸</span> ×¢×“×›×•×Ÿ ××—×™×¨ ×™×“× ×™ (×œ××©×œ × ×™×™×¨×•×ª ×™×©×¨××œ×™×™×)</div>
    <div class="card">
      <div class="card-subtitle">
        ×××¤×©×¨ ×œ×”×–×™×Ÿ ××—×™×¨ ××—×¨×•×Ÿ ×œ× ×™×™×¨ ×‘×œ×™ ×œ×‘×¦×¢ ×§× ×™×™×”/××›×™×¨×” (× ×©××¨ ××§×•××™×ª ×‘×œ×‘×“).
        ×©×™××•×©×™ ×‘××™×•×—×“ ×œ× ×™×™×¨×•×ª ×‘×ª×´× ×©×œ× × ×ª××›×™× ×‘-Alpha Vantage.
      </div>

      <div class="flex-row">
        <div class="flex-1">
          <label>×¡×™××•×œ / ××¡×¤×¨ × ×™×™×¨</label>
          <input id="manualPriceSymbol" placeholder="×œ××©×œ: 5130513 ××• AAPL" />
        </div>
        <div class="flex-1">
          <label>××—×™×¨ ××—×¨×•×Ÿ</label>
          <input id="manualPriceValue" type="number" step="0.0001" placeholder="×œ××©×œ: 123.45" />
        </div>
      </div>

      <div class="flex-row">
        <div class="flex-1">
          <label>××˜×‘×¢</label>
          <input id="manualPriceCurrency" placeholder="ILS / USD / EUR" />
        </div>
        <div class="flex-1">
          <label>×ª××¨×™×š (××•×¤×¦×™×•× ×œ×™)</label>
          <input id="manualPriceDate" type="date" />
        </div>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-primary" id="btnSaveManualPrice">×©××•×¨ ××—×™×¨ ×™×“× ×™</button>
        <button class="btn btn-danger" id="btnDeleteManualPrice">××—×§ ××—×™×¨ ×™×“× ×™ ×œ× ×™×™×¨</button>
      </div>

      <div class="small" style="margin-top:6px;">
        ×˜×™×¤: ××¤×©×¨ ×’× ×œ×œ×—×•×¥ ×¢×œ ×©×•×¨×” ×‘×˜×‘×œ×ª ×”×¤×•×–×™×¦×™×•×ª ×œ××˜×” ×›×“×™ ×œ××œ× ××•×˜×•××˜×™×ª ××ª ×”×¡×™××•×œ ×•×”××˜×‘×¢ ×›××Ÿ.
      </div>
    </div>

    <div class="section-title"><span class="icon">ğŸ“Š</span> Your Positions</div>
    <div class="card">
      <table id="positionsTable">
        <thead>
        <tr>
          <th>× ×™×™×¨</th>
          <th>×›××•×ª</th>
          <th>××˜×‘×¢</th>
          <th>××—×™×¨ ××—×¨×•×Ÿ</th>
          <th>×©×•×•×™ (×‘×¡×™×¡)</th>
          <th>P/L (×‘×¡×™×¡)</th>
          <th>P/L %</th>
          <th>Net P/L (×‘×¡×™×¡)</th>
          <th>Net %</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:6px;">
        Net ×›×•×œ×œ: ××¡ ×“×™×‘×™×“× ×“ ××©×•×¢×¨ + ××¡ ×¨×•×•×—×™ ×”×•×Ÿ ×××•××© ×‘×¤×•×¢×œ (×¨×§ ×‘××›×™×¨×” ×•×‘×¨×•×•×—), ×œ×¤×™ 25% ×‘×¨×™×¨×ª ××—×“×œ.
      </div>
    </div>

    <div class="section-title"><span class="icon">ğŸ§©</span> Allocation by Symbol</div>
    <div class="card">
      <canvas id="allocationChart" height="190"></canvas>
      <div class="small" id="chartFallback" style="margin-top:8px; display:none;">
        âš ï¸ Chart.js ×œ× × ×˜×¢×Ÿ (×œ××©×œ ××™×Ÿ ××™× ×˜×¨× ×˜ ×‘-PWA). ×”××¤×œ×™×§×¦×™×” ×ª××©×™×š ×œ×¢×‘×•×“ ×‘×œ×™ ×”×’×¨×£.
      </div>
      <div id="allocationLegend" class="legend-wrap"></div>
      <div class="small" style="margin-top:8px;">×”×’×¨×£ ××¦×™×’ Top 7 ×œ×¤×™ ×©×•×•×™ + "××—×¨".</div>
    </div>
  </div>

  <!-- TRADES -->
  <div class="screen" id="screen-trades">
    <div class="section-title"><span class="icon">â•</span> ×”×•×¡×¤×ª / ×¢×¨×™×›×ª ×¢×¡×§×”</div>
    <div class="card">
      <form id="tradeForm">
        <div class="flex-row">
          <div class="flex-1">
            <label>×¡×•×’ ×¢×¡×§×”</label>
            <select id="tradeType" required>
              <option value="buy">×§× ×™×™×”</option>
              <option value="sell">××›×™×¨×”</option>
            </select>
          </div>
          <div class="flex-1">
            <label>×¡×™××•×œ (Ticker)</label>
            <input id="tradeSymbol" required placeholder="×œ××©×œ: AAPL" />
          </div>
        </div>
        <div class="flex-row">
          <div class="flex-1">
            <label>×›××•×ª</label>
            <input id="tradeQty" type="number" step="0.0001" required />
          </div>
          <div class="flex-1">
            <label>××—×™×¨ ×œ×™×—×™×“×”</label>
            <input id="tradePrice" type="number" step="0.0001" required />
          </div>
        </div>
        <div class="flex-row">
          <div class="flex-1">
            <label>××˜×‘×¢ ×”× ×™×™×¨</label>
            <input id="tradeCurrency" placeholder="USD / ILS / EUR" required />
          </div>
          <div class="flex-1">
            <label>×¢××œ×”</label>
            <input id="tradeFee" type="number" step="0.01" value="0" />
          </div>
        </div>
        <label>×ª××¨×™×š ×¢×¡×§×”</label>
        <input id="tradeDate" type="date" required />

        <button type="submit" class="btn btn-primary" id="btnSaveTrade" style="margin-top:4px;">×©××•×¨ ×¢×¡×§×”</button>
        <button type="button" class="btn btn-secondary btn-small" id="btnCancelEditTrade" style="margin-top:4px; margin-right:6px; display:none;">×‘×™×˜×•×œ ×¢×¨×™×›×”</button>

        <div id="editTradeIndicator" class="edit-indicator">××¦×‘ ×¢×¨×™×›×” ×¤×¢×™×œ â€“ ×›×œ ×©××™×¨×” ×ª×¢×“×›×Ÿ ××ª ×”×¢×¡×§×” ×”× ×‘×—×¨×ª.</div>
      </form>
    </div>

    <div class="section-title"><span class="icon">ğŸ“œ</span> ×¨×©×™××ª ×¢×¡×§××•×ª</div>
    <div class="card">
      <div class="card-title-row">
        <div class="card-title">×¢×¡×§××•×ª</div>
        <span class="tag" id="tradesCountTag"></span>
      </div>
      <table id="tradesTable">
        <thead>
        <tr>
          <th>×ª××¨×™×š</th><th>×¡×•×’</th><th>× ×™×™×¨</th><th>×›××•×ª</th><th>××—×™×¨</th><th>××˜×‘×¢</th><th>×¢××œ×”</th><th>×¢×¨×™×›×”</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="btnClearTrades" class="btn btn-danger" style="margin-top:8px;">××—×§ ××ª ×›×œ ×”×¢×¡×§××•×ª</button>
      <div class="small">âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ â€“ ××•×—×§ ××”××—×¡×•×Ÿ ×”××§×•××™.</div>
    </div>
  </div>

  <!-- DIVIDENDS -->
  <div class="screen" id="screen-dividends">
    <div class="section-title"><span class="icon">ğŸ’°</span> ×”×•×¡×¤×ª ×“×™×‘×™×“× ×“ / ×§×•×¤×•×Ÿ ×™×“× ×™</div>
    <div class="card">
      <form id="dividendForm">
        <label>× ×™×™×¨</label>
        <input id="divSymbol" placeholder="×œ××©×œ: AAPL" required />
        <div class="flex-row">
          <div class="flex-1">
            <label>×¡×›×•× (×‘×¨×•×˜×•)</label>
            <input id="divAmount" type="number" step="0.01" required />
          </div>
          <div class="flex-row">
            <div class="flex-1">
              <label>××˜×‘×¢</label>
              <input id="divCurrency" placeholder="USD / ILS / EUR" required />
            </div>
          </div>
        </div>
        <label>×ª××¨×™×š ×§×‘×œ×”</label>
        <input id="divDate" type="date" required />
        <button type="submit" class="btn btn-primary" style="margin-top:4px;">×©××•×¨ ×“×™×‘×™×“× ×“</button>
      </form>
      <div class="small" style="margin-top:6px;">
        ××¡ ××©×•×¢×¨: 25% (××•×¦×’ ×‘×˜×‘×œ×” ×›-Tax + Net).
      </div>
    </div>

    <div class="section-title"><span class="icon">âš™ï¸</span> ×™×™×‘×•× ××•×˜×•××˜×™ ×-Alpha Vantage</div>
    <div class="card">
      <div class="card-subtitle">
        ×™×™×‘×•× ×“×™×‘×™×“× ×“×™× ×”×™×¡×˜×•×¨×™×™× ×œ×¤×™ ×¡×™××•×œ ×‘×××¦×¢×•×ª Alpha Vantage.
        ×”× ×ª×•× ×™× × ×©××¨×™× ××§×•××™×ª ×‘×œ×‘×“. ×™×© ××’×‘×œ×ª ×§×¨×™××•×ª (5 ×œ×“×§×” / 500 ×‘×™×•×).
      </div>
      <div class="flex-row">
        <div class="flex-1">
          <label>×¡×™××•×œ (Ticker)</label>
          <input id="importDivSymbolAv" placeholder="×œ××©×œ: AAPL" />
        </div>
        <div class="flex-1">
          <label>×˜×•×•×— ×–××Ÿ</label>
          <select id="importDivYearsAv">
            <option value="1">×©× ×” ××—×¨×•× ×”</option>
            <option value="3">3 ×©× ×™×</option>
            <option value="5">5 ×©× ×™×</option>
            <option value="10">10 ×©× ×™×</option>
          </select>
        </div>
      </div>
      <button id="btnImportDivAlpha" class="btn btn-secondary" style="margin-top:4px;">×™×™×‘× ×“×™×‘×™×“× ×“×™× ×-Alpha Vantage</button>
      <div class="small" style="margin-top:6px;">
        ××ª×‘×¡×¡ ×¢×œ <code>TIME_SERIES_MONTHLY_ADJUSTED</code>.<br/>
        ××•×‘××™× ×¨×§ ×“×™×‘×™×“× ×“×™× ×©× ××¦××™× ×‘×ª×•×š ×ª×§×•×¤×•×ª ×”×”×—×–×§×” ×‘×¤×•×¢×œ (×œ×¤×™ ×”×¢×¡×§××•×ª) ×•×”× ××•×›×¤×œ×™× ×‘×›××•×ª ×”×× ×™×•×ª ×©×”×—×–×§×ª ×‘××•×ª×• ×ª××¨×™×š.
      </div>
    </div>

    <div class="section-title"><span class="icon">ğŸ“œ</span> ×¨×©×™××ª ×“×™×‘×™×“× ×“×™× / ×§×•×¤×•× ×™×</div>
    <div class="card">
      <div class="card-title-row">
        <div class="card-title">×“×™×‘×™×“× ×“×™×</div>
        <span class="tag" id="divCountTag"></span>
      </div>
      <table id="divTable">
        <thead>
        <tr>
          <th>×ª××¨×™×š</th>
          <th>× ×™×™×¨</th>
          <th>Gross</th>
          <th>Tax (25%)</th>
          <th>Net</th>
          <th>××˜×‘×¢</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="btnClearDividends" class="btn btn-danger" style="margin-top:8px;">××—×§ ××ª ×›×œ ×”×“×™×‘×™×“× ×“×™×</button>
      <div class="small">âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ â€“ ××•×—×§ ××”××—×¡×•×Ÿ ×”××§×•××™.</div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="screen" id="screen-settings">
    <div class="section-title"><span class="icon">ğŸ§­</span> ×”×’×“×¨×•×ª ××˜×‘×¢ ×•×©×¢×¨×™ ×”××¨×”</div>
    <div class="card">
      <label>××˜×‘×¢ ×‘×¡×™×¡</label>
      <input id="baseCurrencyInput" placeholder="ILS / USD / EUR" />
      <div class="small" style="margin-top:6px;">
        ×©×¢×¨×™ ×”××¨×” (×›××” ×©×•×•×” 1 ×™×—×™×“×ª ××˜×‘×¢ ×‘××˜×‘×¢ ×”×‘×¡×™×¡).<br/>
        ×œ×“×•×’××”: ×× ×‘×¡×™×¡ = ILS ×•-USD = 3.7 â€“ ××– ×›×œ 1 ×“×•×œ×¨ = 3.7 ×©"×—.
      </div>
      <div id="fxRatesContainer" style="margin-top:8px;"></div>

      <button id="btnAddCurrency" class="btn btn-secondary" style="margin-top:8px;">×”×•×¡×£ ××˜×‘×¢</button>
      <button id="btnSaveSettings" class="btn btn-primary" style="margin-top:8px;">×©××•×¨ ×”×’×“×¨×•×ª</button>

      <div class="checkbox-row">
        <input id="enableOnlineQuotes" type="checkbox" />
        <label for="enableOnlineQuotes">××¤×©×¨ ×¢×“×›×•×Ÿ ××—×™×¨×™ ×©×•×§ ××•× ×œ×™×™×Ÿ (×©×™××•×© ×‘-Alpha Vantage). × ×©×œ×—×™× ×¨×§ ×¡×™××•×œ×™× ×•-API key, ×œ×œ× ×›××•×™×•×ª/×©×•×•×™ ×ª×™×§.</label>
      </div>

      <label style="margin-top:6px;">Alpha Vantage API Key</label>
      <input id="alphaVantageKey" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”-API key ×©×œ×š" />
      <div class="small">×œ×“×•×’××”: 123456</div>
    </div>

    <div class="section-title"><span class="icon">ğŸ§¾</span> ××¡ (×‘×¨×™×¨×ª ××—×“×œ 25%)</div>
    <div class="card">
      <div class="small">
        ×›×¨×’×¢ ×–×” ×§×‘×•×¢ ×‘×§×•×“ ×›Ö¾25% (×›×¤×™ ×©×‘×™×§×©×ª). ×× ×ª×¨×¦×” ×‘×”××©×š ×œ×”×¤×•×š ××ª ×–×” ×œ×©×“×•×ª ×”×’×“×¨×” â€“ ×ª×’×™×“ ×•×× ×™ ××•×¡×™×£.
      </div>
      <div class="small" style="margin-top:6px;">
        â€¢ ××¡ ×¨×•×•×— ×”×•×Ÿ: ×¨×§ ×‘××™××•×© ×‘×¤×•×¢×œ ×•×‘×¨×•×•×— ×‘×œ×‘×“<br/>
        â€¢ ××¡ ×“×™×‘×™×“× ×“/×§×•×¤×•×Ÿ: ××©×•×¢×¨ ×¢×œ ×›×œ ×¨×©×•××” ×‘××¢×¨×›×ª
      </div>
    </div>

    <div class="section-title"><span class="icon">ğŸ›Ÿ</span> ×’×™×‘×•×™ / ×©×—×–×•×¨ × ×ª×•× ×™×</div>
    <div class="card">
      <button id="btnExport" class="btn btn-secondary" style="margin-bottom:6px;">×™×™×¦× JSON</button>
      <div class="small">×™×•×¦×¨ ×˜×§×¡×˜ JSON ×©×œ ×›×œ ×”× ×ª×•× ×™× (×¢×¡×§××•×ª, ×“×™×‘×™×“× ×“×™×, ×”×’×“×¨×•×ª) ×©××¤×©×¨ ×œ×©××•×¨ ×‘×§×•×‘×¥ ×—×™×¦×•× ×™.</div>
      <textarea id="exportArea" rows="6" style="margin-top:8px;"></textarea>
      <button id="btnImport" class="btn btn-primary" style="margin-top:6px;">×™×™×‘× JSON</button>
      <div class="small">××–×”×¨×”: ×™×™×‘×•× ×™×©×›×ª×‘ ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™×.</div>
    </div>

    <div class="section-title"><span class="icon">ğŸ”’</span> ×¤×¨×˜×™×•×ª</div>
    <div class="card">
      <div class="small">
        â€¢ ×›×œ ×”××™×“×¢ × ×©××¨ ×‘-localStorage ×‘×“×¤×“×¤×Ÿ ×‘×œ×‘×“.<br/>
        â€¢ ×›××©×¨ ×¢×“×›×•×Ÿ ××—×™×¨×™ ×©×•×§ ×›×‘×•×™ â€“ ××™×Ÿ ×™×¦×™××” ×œ××™× ×˜×¨× ×˜ ×‘×›×œ×œ.<br/>
        â€¢ ×›××©×¨ ×”×•× ×¤×¢×™×œ â€“ × ×©×œ×—×™× ×œ-Alpha Vantage ×¨×§ ×¡×™××•×œ×™× ×•-API key ×©×œ×š.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const errorBar = document.getElementById('errorBar');
  function showErr(msg) {
    errorBar.textContent = msg;
    errorBar.classList.add('show');
  }
  window.addEventListener('error', (e) => showErr('JS Error: ' + (e.message || e.error || e)));
  window.addEventListener('unhandledrejection', (e) => showErr('Promise Error: ' + (e.reason?.message || e.reason || e)));

  const STORAGE_KEY = 'invest_app_state_v4';

  // Taxes (as requested)
  const TAX_RATE_CAP_GAIN = 0.25; // on realized gains only
  const TAX_RATE_DIV = 0.25;      // estimated withholding on dividends/coupons

  let state = {
    trades: [],
    dividends: [],
    settings: {
      baseCurrency: 'ILS',
      fxRates: { ILS: 1, USD: 3.7, EUR: 4.0 },
      enableOnlineQuotes: false,
      alphaVantageKey: ''
    },
    lastPrices: {}
  };

  let currentEditTradeId = null;
  let allocationChart = null;

  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        const saved = JSON.parse(raw);
        state = Object.assign(state, saved);
        state.settings = Object.assign({
          baseCurrency: 'ILS',
          fxRates: { ILS: 1 },
          enableOnlineQuotes: false,
          alphaVantageKey: ''
        }, state.settings || {});
        state.lastPrices = state.lastPrices || {};
      } catch (e) {
        console.error('Error loading state', e);
        showErr('Error loading state: ' + (e.message || e));
      }
    }
  }

  function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  // Tabs
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const screenName = tab.dataset.screen;
      document.querySelectorAll('.screen').forEach(s => {
        s.classList.toggle('active', s.id === 'screen-' + screenName);
      });
    });
  });

  function getFxRate(currency) {
    const base = state.settings.baseCurrency;
    if (currency === base) return 1;
    const fxRates = state.settings.fxRates || {};
    const r = fxRates[currency];
    if (typeof r === 'number' && !isNaN(r) && r > 0) return r;
    return 1;
  }

  function amountToBase(amount, currency) { return amount * getFxRate(currency); }

  function normalizeSymbol(raw) { return (raw || '').trim().toUpperCase(); }

  function buildPositions() {
    const map = {};
    state.trades.forEach(tr => {
      const key = normalizeSymbol(tr.symbol);
      if (!key) return;

      if (!map[key]) {
        map[key] = { symbol: key, currency: tr.currency, qty: 0, lastPrice: tr.price, lastPriceSource: 'trade', lastPriceDate: tr.date };
      }
      const p = map[key];
      const signedQty = (tr.type === 'buy' ? 1 : -1) * Number(tr.qty);
      p.qty += signedQty;

      if (tr.date >= p.lastPriceDate) {
        p.lastPrice = tr.price;
        p.lastPriceDate = tr.date;
        p.currency = tr.currency;
      }

      // lastPrices (manual/api) override
      if (state.lastPrices[key]) {
        p.lastPrice = state.lastPrices[key].price;
        p.currency = state.lastPrices[key].currency;
        p.lastPriceSource = state.lastPrices[key].source || 'api';
        p.lastPriceDate = state.lastPrices[key].updatedAt;
      }
    });

    // only open positions
    return Object.values(map).filter(p => Math.abs(p.qty) > 1e-12);
  }

  // --- Weighted-average cost basis + realized taxes per symbol ---
  function computePerSymbolStats() {
    const pos = {};
    const tradesSorted = state.trades.slice().sort((a,b) => a.date.localeCompare(b.date));

    for (const tr of tradesSorted) {
      const sym = normalizeSymbol(tr.symbol);
      if (!sym) continue;
      const qty = Number(tr.qty);
      const price = Number(tr.price);
      const fee = Number(tr.fee || 0);

      const amount = qty * price;
      const amountBase = amountToBase(amount, tr.currency);
      const feeBase = amountToBase(fee, tr.currency);

      if (!pos[sym]) {
        pos[sym] = {
          symbol: sym,
          qty: 0,
          costBaseOpen: 0,
          realizedGainBase: 0,
          realizedTaxBase: 0,
          buysBase: 0,
          sellsBase: 0,
          feesBaseTotal: 0,
        };
      }

      const p = pos[sym];
      p.feesBaseTotal += feeBase;

      if (tr.type === 'buy') {
        p.qty += qty;
        p.costBaseOpen += (amountBase + feeBase);
        p.buysBase += (amountBase + feeBase);
      } else {
        const qtySell = qty;
        if (p.qty <= 0) {
          p.sellsBase += (amountBase - feeBase);
          continue;
        }
        const qtyUsed = Math.min(qtySell, p.qty);
        const avgCostBase = (p.qty > 0) ? (p.costBaseOpen / p.qty) : 0;
        const bookCost = avgCostBase * qtyUsed;

        const proceedsNetOfFee = (amountBase - feeBase) * (qtyUsed / qtySell);
        const realizedGain = proceedsNetOfFee - bookCost;
        const realizedTax = Math.max(0, realizedGain) * TAX_RATE_CAP_GAIN;

        p.realizedGainBase += realizedGain;
        p.realizedTaxBase += realizedTax;

        p.qty -= qtyUsed;
        p.costBaseOpen -= bookCost;

        p.sellsBase += proceedsNetOfFee;
      }
    }

    const divGrossBySym = {};
    const divNetBySym = {};
    let totalDivGrossBase = 0;
    let totalDivNetBase = 0;

    for (const d of state.dividends) {
      const sym = normalizeSymbol(d.symbol);
      const amt = Number(d.amount);
      const amtBase = amountToBase(amt, d.currency);
      const netBase = amtBase * (1 - TAX_RATE_DIV);

      totalDivGrossBase += amtBase;
      totalDivNetBase += netBase;

      divGrossBySym[sym] = (divGrossBySym[sym] || 0) + amtBase;
      divNetBySym[sym] = (divNetBySym[sym] || 0) + netBase;
    }

    const allSyms = new Set([...Object.keys(pos), ...Object.keys(divGrossBySym)]);
    for (const sym of allSyms) {
      if (!pos[sym]) pos[sym] = { symbol:sym, qty:0, costBaseOpen:0, realizedGainBase:0, realizedTaxBase:0, buysBase:0, sellsBase:0, feesBaseTotal:0 };
      pos[sym].divGrossBase = divGrossBySym[sym] || 0;
      pos[sym].divNetBase = divNetBySym[sym] || 0;
    }

    const totals = {
      totalDivGrossBase,
      totalDivNetBase,
      totalDivTaxBase: totalDivGrossBase - totalDivNetBase,
      totalRealizedTaxBase: Object.values(pos).reduce((s,p)=>s + (p.realizedTaxBase||0), 0),
      totalRealizedGainBase: Object.values(pos).reduce((s,p)=>s + (p.realizedGainBase||0), 0),
    };

    return { pos, totals };
  }

  function computeCashFlowsAndSummary() {
    const flowsGross = [];
    const flowsNet = [];

    let totalBuysBase = 0;
    let totalSellsBase = 0;
    let totalFeesBase = 0;

    const tradesSorted = state.trades.slice().sort((a,b) => a.date.localeCompare(b.date));
    const book = {};

    function pushFlow(arr, date, amount){ arr.push({ date, amount }); }

    for (const tr of tradesSorted) {
      const sym = normalizeSymbol(tr.symbol);
      if (!sym) continue;
      const qty = Number(tr.qty);
      const price = Number(tr.price);
      const fee = Number(tr.fee || 0);
      const dateStr = tr.date;

      const amount = qty * price;
      const amountBase = amountToBase(amount, tr.currency);
      const feeBase = amountToBase(fee, tr.currency);

      if (!book[sym]) book[sym] = { qty: 0, costBaseOpen: 0 };

      if (tr.type === 'buy') {
        pushFlow(flowsGross, dateStr, -(amountBase + feeBase));
        pushFlow(flowsNet, dateStr, -(amountBase + feeBase));

        totalBuysBase += amountBase;
        totalFeesBase += feeBase;

        book[sym].qty += qty;
        book[sym].costBaseOpen += (amountBase + feeBase);
      } else {
        pushFlow(flowsGross, dateStr, (amountBase - feeBase));

        totalSellsBase += amountBase;
        totalFeesBase += feeBase;

        let realizedTax = 0;
        if (book[sym].qty > 0) {
          const qtyUsed = Math.min(qty, book[sym].qty);
          const avgCostBase = book[sym].costBaseOpen / book[sym].qty;
          const bookCost = avgCostBase * qtyUsed;

          const proceedsNetOfFee = (amountBase - feeBase) * (qtyUsed / qty);
          const realizedGain = proceedsNetOfFee - bookCost;
          realizedTax = Math.max(0, realizedGain) * TAX_RATE_CAP_GAIN;

          book[sym].qty -= qtyUsed;
          book[sym].costBaseOpen -= bookCost;
        }

        pushFlow(flowsNet, dateStr, (amountBase - feeBase) - realizedTax);
      }
    }

    let totalDividendsGrossBase = 0;
    let totalDividendsNetBase = 0;

    state.dividends.forEach(d => {
      const amt = Number(d.amount);
      const amtBase = amountToBase(amt, d.currency);
      const netBase = amtBase * (1 - TAX_RATE_DIV);

      totalDividendsGrossBase += amtBase;
      totalDividendsNetBase += netBase;

      pushFlow(flowsGross, d.date, amtBase);
      pushFlow(flowsNet, d.date, netBase);
    });

    const positions = buildPositions();
    let marketValueBase = 0;
    positions.forEach(p => {
      const value = Number(p.qty) * Number(p.lastPrice || 0);
      marketValueBase += amountToBase(value, p.currency);
    });

    const todayIso = new Date().toISOString().slice(0,10);
    if (marketValueBase !== 0) {
      pushFlow(flowsGross, todayIso, marketValueBase);
      pushFlow(flowsNet, todayIso, marketValueBase);
    }

    const profitGrossBase = (marketValueBase + totalSellsBase + totalDividendsGrossBase) - (totalBuysBase + totalFeesBase);

    const { totals } = computePerSymbolStats();
    const estimatedTaxesBase = (totals.totalDivTaxBase || 0) + (totals.totalRealizedTaxBase || 0);

    const profitNetBase = profitGrossBase - estimatedTaxesBase;

    const netInvestedGrossBase = (totalBuysBase + totalFeesBase) - (totalSellsBase + totalDividendsGrossBase);

    return {
      flowsGross,
      flowsNet,
      profitGrossBase,
      profitNetBase,
      marketValueBase,
      netInvestedGrossBase,
      totalDividendsGrossBase,
      totalDividendsNetBase,
      totalBuysBase,
      totalSellsBase,
      estimatedTaxesBase
    };
  }

  function xirr(cashFlows) {
    if (!cashFlows || cashFlows.length < 2) return null;
    cashFlows = cashFlows.slice().sort((a,b) => a.date.localeCompare(b.date));
    const day0 = new Date(cashFlows[0].date);
    const values = cashFlows.map(cf => cf.amount);
    const times = cashFlows.map(cf => (new Date(cf.date) - day0) / (1000*60*60*24) / 365.0);

    function npv(rate) {
      let sum = 0;
      for (let i=0;i<values.length;i++) sum += values[i] / Math.pow(1+rate, times[i]);
      return sum;
    }
    function dNpv(rate) {
      let sum = 0;
      for (let i=0;i<values.length;i++) sum += -times[i] * values[i] / Math.pow(1+rate, times[i]+1);
      return sum;
    }

    let guess = 0.1;
    for (let i=0;i<100;i++) {
      const f = npv(guess);
      const df = dNpv(guess);
      if (Math.abs(df) < 1e-12) break;
      const newGuess = guess - f/df;
      if (Math.abs(newGuess-guess) < 1e-6) { guess = newGuess; break; }
      guess = newGuess;
    }
    if (!isFinite(guess) || guess < -0.9999) return null;
    return guess;
  }

  function fmtMoney(x, base) {
    if (!isFinite(x)) return '-';
    return Number(x).toFixed(2) + ' ' + base;
  }
  function fmtPct(x) {
    if (!isFinite(x)) return '-';
    return (x >= 0 ? '+' : '') + x.toFixed(2) + ' %';
  }

  // Chart palette (distinct colors)
  const CHART_COLORS = [
    '#60a5fa', '#34d399', '#fbbf24', '#f87171', '#a78bfa', '#fb7185', '#22c55e',
    '#38bdf8', '#f59e0b', '#e879f9', '#4ade80', '#93c5fd'
  ];

  function buildAllocationTopN(positions, n=7) {
    const rows = positions.map(p => {
      const valBase = amountToBase(p.qty * (p.lastPrice || 0), p.currency);
      return { symbol: p.symbol, valueBase: valBase };
    }).filter(r => Math.abs(r.valueBase) > 0.01);

    rows.sort((a,b)=>b.valueBase - a.valueBase);

    const top = rows.slice(0, n);
    const rest = rows.slice(n);
    const otherSum = rest.reduce((s,r)=>s+r.valueBase, 0);

    if (otherSum > 0.01) top.push({ symbol:'××—×¨', valueBase: otherSum });

    const labels = top.map(r=>r.symbol);
    const data = top.map(r=>r.valueBase);
    return { labels, data, rows: top };
  }

  function renderLegend(chartRows, base, totalValueBase) {
    const legend = document.getElementById('allocationLegend');
    legend.innerHTML = '';
    chartRows.forEach((r, idx) => {
      const pct = totalValueBase > 0 ? (r.valueBase / totalValueBase * 100) : 0;
      const item = document.createElement('div');
      item.className = 'legend-item';
      item.innerHTML = `
        <span class="legend-swatch" style="background:${CHART_COLORS[idx % CHART_COLORS.length]}"></span>
        <div class="legend-text">
          <div class="t1">${r.symbol}</div>
          <div class="t2">${pct.toFixed(1)}% â€¢ ${fmtMoney(r.valueBase, base)}</div>
        </div>
      `;
      legend.appendChild(item);
    });
  }

  function renderPortfolio() {
    document.getElementById('baseCurrencyLabel').textContent = state.settings.baseCurrency;

    const {
      flowsGross, flowsNet,
      profitGrossBase, profitNetBase,
      marketValueBase,
      netInvestedGrossBase,
      totalDividendsGrossBase, totalDividendsNetBase,
      totalBuysBase,
      estimatedTaxesBase
    } = computeCashFlowsAndSummary();

    const base = state.settings.baseCurrency;

    document.getElementById('portfolioValue').textContent = fmtMoney(marketValueBase, base);
    document.getElementById('portfolioInvested').textContent = fmtMoney(totalBuysBase, base);

    const plEl = document.getElementById('portfolioPL');
    const plNetEl = document.getElementById('portfolioPLNet');

    if (profitGrossBase > 0) {
      plEl.textContent = '+' + fmtMoney(profitGrossBase, base);
      plEl.classList.remove('metric-negative');
      plEl.classList.add('metric-positive');
    } else if (profitGrossBase < 0) {
      plEl.textContent = fmtMoney(profitGrossBase, base);
      plEl.classList.remove('metric-positive');
      plEl.classList.add('metric-negative');
    } else {
      plEl.textContent = fmtMoney(profitGrossBase, base);
      plEl.classList.remove('metric-positive','metric-negative');
      plEl.classList.add('metric-neutral');
    }

    plNetEl.textContent = fmtMoney(profitNetBase, base);

    const retEl = document.getElementById('portfolioReturn');
    if (netInvestedGrossBase > 0) {
      const pct = (profitGrossBase / netInvestedGrossBase) * 100;
      retEl.textContent = fmtPct(pct);
      retEl.classList.toggle('metric-positive', pct >= 0);
      retEl.classList.toggle('metric-negative', pct < 0);
    } else {
      retEl.textContent = '-';
      retEl.classList.remove('metric-positive','metric-negative');
      retEl.classList.add('metric-neutral');
    }

    const rateGross = xirr(flowsGross);
    const rateNet = xirr(flowsNet);
    document.getElementById('portfolioXirr').textContent = rateGross === null ? '-' : (rateGross * 100).toFixed(2) + ' %';
    document.getElementById('portfolioXirrNet').textContent = rateNet === null ? '-' : (rateNet * 100).toFixed(2) + ' %';

    document.getElementById('portfolioDividends').textContent = fmtMoney(totalDividendsGrossBase, base);
    document.getElementById('portfolioDividendsNet').textContent = fmtMoney(totalDividendsNetBase, base);

    const taxEl = document.getElementById('portfolioTaxes');
    taxEl.textContent = fmtMoney(estimatedTaxesBase, base);
    taxEl.classList.toggle('metric-negative', estimatedTaxesBase > 0);
    taxEl.classList.toggle('metric-neutral', estimatedTaxesBase <= 0);

    // Positions
    const positions = buildPositions();
    const tbody = document.querySelector('#positionsTable tbody');
    tbody.innerHTML = '';

    const { pos: symStats } = computePerSymbolStats();

    positions.forEach(p => {
      const row = document.createElement('tr');

      const valueBase = amountToBase(p.qty * (p.lastPrice || 0), p.currency);

      const st = symStats[p.symbol] || {};
      const openCostBase = Number(st.costBaseOpen || 0);
      const divGrossBase = Number(st.divGrossBase || 0);
      const divNetBase = Number(st.divNetBase || 0);
      const realizedTaxBase = Number(st.realizedTaxBase || 0);

      const plGross = (valueBase + divGrossBase) - openCostBase;
      const plNet = (valueBase + divNetBase) - openCostBase - realizedTaxBase;

      const pctGross = openCostBase > 0 ? (plGross / openCostBase) * 100 : NaN;
      const pctNet = openCostBase > 0 ? (plNet / openCostBase) * 100 : NaN;

      row.innerHTML = `
        <td>${p.symbol}</td>
        <td>${Number(p.qty).toFixed(4)}</td>
        <td>${p.currency}</td>
        <td>${(p.lastPrice || p.lastPrice === 0) ? Number(p.lastPrice).toFixed(4) : '-'}</td>
        <td>${fmtMoney(valueBase, base)}</td>
        <td>${fmtMoney(plGross, base)}</td>
        <td>${isFinite(pctGross) ? fmtPct(pctGross) : '-'}</td>
        <td>${fmtMoney(plNet, base)}</td>
        <td>${isFinite(pctNet) ? fmtPct(pctNet) : '-'}</td>
      `;

      row.style.cursor = 'pointer';
      row.title = '×œ×—×¥ ×›×“×™ ×œ××œ× ×‘×˜×•×¤×¡ "×¢×“×›×•×Ÿ ××—×™×¨ ×™×“× ×™"';
      row.addEventListener('click', () => {
        const symInput = document.getElementById('manualPriceSymbol');
        const curInput = document.getElementById('manualPriceCurrency');
        const dateInput = document.getElementById('manualPriceDate');

        if (symInput) symInput.value = p.symbol;
        if (curInput && p.currency) curInput.value = (p.currency || '').toUpperCase();
        if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().slice(0,10);

        symInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });

      tbody.appendChild(row);
    });

    // Allocation chart (Top 7 + Other) + legend
    const statusEl = document.getElementById('onlineQuotesStatus');
    statusEl.textContent = state.settings.enableOnlineQuotes
      ? '×¢×“×›×•×Ÿ ××—×™×¨×™ ×©×•×§ ××•× ×œ×™×™×Ÿ: ×¤×¢×™×œ (Alpha Vantage - GLOBAL_QUOTE).'
      : '×¢×“×›×•×Ÿ ××—×™×¨×™ ×©×•×§ ××•× ×œ×™×™×Ÿ: ×›×‘×•×™ (××™×Ÿ ×™×¦×™××” ×œ××™× ×˜×¨× ×˜).';

    const chartFallback = document.getElementById('chartFallback');
    if (typeof window.Chart !== 'function') {
      chartFallback.style.display = 'block';
      return;
    }
    chartFallback.style.display = 'none';

    const { labels, data, rows } = buildAllocationTopN(positions, 7);

    const canvas = document.getElementById('allocationChart');
    const ctx = canvas.getContext('2d');
    if (allocationChart) allocationChart.destroy();

    allocationChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: labels.map((_,i)=>CHART_COLORS[i % CHART_COLORS.length]),
          borderColor: 'rgba(2,6,23,0.7)',
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const v = ctx.parsed;
                const total = data.reduce((s,x)=>s+x,0);
                const pct = total > 0 ? (v/total*100) : 0;
                return `${ctx.label}: ${fmtMoney(v, base)} (${pct.toFixed(1)}%)`;
              }
            }
          }
        },
        cutout: '58%'
      }
    });

    const totalValueForChart = data.reduce((s,x)=>s+x,0);
    renderLegend(rows, base, totalValueForChart);
  }

  function renderTrades() {
    const tbody = document.querySelector('#tradesTable tbody');
    tbody.innerHTML = '';
    const sorted = state.trades.slice().sort((a,b) => a.date.localeCompare(b.date));
    sorted.forEach(tr => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${tr.date}</td>
        <td>${tr.type === 'buy' ? '×§× ×™×™×”' : '××›×™×¨×”'}</td>
        <td>${normalizeSymbol(tr.symbol)}</td>
        <td>${Number(tr.qty).toFixed(4)}</td>
        <td>${Number(tr.price).toFixed(4)}</td>
        <td>${tr.currency}</td>
        <td>${Number(tr.fee || 0).toFixed(2)}</td>
        <td><button class="btn btn-secondary btn-small" data-edit-id="${tr.id}">âœï¸</button></td>
      `;
      tbody.appendChild(row);
    });
    document.getElementById('tradesCountTag').textContent = sorted.length + ' ×¢×¡×§××•×ª';

    tbody.querySelectorAll('button[data-edit-id]').forEach(btn => {
      btn.addEventListener('click', () => startEditTrade(btn.getAttribute('data-edit-id')));
    });
  }

  function renderDividends() {
    const tbody = document.querySelector('#divTable tbody');
    tbody.innerHTML = '';
    const sorted = state.dividends.slice().sort((a,b) => a.date.localeCompare(b.date));
    sorted.forEach(d => {
      const gross = Number(d.amount);
      const tax = isFinite(gross) ? gross * TAX_RATE_DIV : NaN;
      const net = isFinite(gross) ? gross * (1 - TAX_RATE_DIV) : NaN;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${d.date}</td>
        <td>${normalizeSymbol(d.symbol)}</td>
        <td>${isFinite(gross) ? gross.toFixed(2) : '-'}</td>
        <td>${isFinite(tax) ? tax.toFixed(2) : '-'}</td>
        <td>${isFinite(net) ? net.toFixed(2) : '-'}</td>
        <td>${d.currency}</td>
      `;
      tbody.appendChild(row);
    });
    document.getElementById('divCountTag').textContent = sorted.length + ' ×¨×©×•××•×ª';
  }

  function renderSettings() {
    document.getElementById('baseCurrencyInput').value = state.settings.baseCurrency || 'ILS';

    const container = document.getElementById('fxRatesContainer');
    container.innerHTML = '';
    const fx = state.settings.fxRates || {};
    Object.keys(fx).forEach(curr => {
      const row = document.createElement('div');
      row.className = 'flex-row';
      row.style.marginBottom = '4px';
      row.innerHTML = `
        <div class="flex-1"><input data-fx-currency placeholder="××˜×‘×¢" value="${curr}" /></div>
        <div class="flex-1"><input data-fx-rate type="number" step="0.0001" placeholder="×©×¢×¨" value="${fx[curr]}" /></div>
      `;
      container.appendChild(row);
    });

    document.getElementById('enableOnlineQuotes').checked = !!state.settings.enableOnlineQuotes;
    document.getElementById('alphaVantageKey').value = state.settings.alphaVantageKey || '';
  }

  function setDefaultDates() {
    const today = new Date().toISOString().slice(0,10);
    const tradeDate = document.getElementById('tradeDate');
    const divDate = document.getElementById('divDate');
    const manualDate = document.getElementById('manualPriceDate');
    if (tradeDate && !tradeDate.value) tradeDate.value = today;
    if (divDate && !divDate.value) divDate.value = today;
    if (manualDate && !manualDate.value) manualDate.value = today;
  }

  // Trade form + edit
  function resetTradeForm() {
    document.getElementById('tradeForm').reset();
    currentEditTradeId = null;
    document.getElementById('btnSaveTrade').textContent = '×©××•×¨ ×¢×¡×§×”';
    document.getElementById('editTradeIndicator').classList.remove('active');
    document.getElementById('btnCancelEditTrade').style.display = 'none';
    setDefaultDates();
  }

  function startEditTrade(id) {
    const tr = state.trades.find(t => t.id === id);
    if (!tr) return;
    currentEditTradeId = id;

    document.getElementById('tradeType').value = tr.type;
    document.getElementById('tradeSymbol').value = tr.symbol;
    document.getElementById('tradeQty').value = tr.qty;
    document.getElementById('tradePrice').value = tr.price;
    document.getElementById('tradeCurrency').value = tr.currency;
    document.getElementById('tradeFee').value = tr.fee || 0;
    document.getElementById('tradeDate').value = tr.date;

    document.getElementById('btnSaveTrade').textContent = '×¢×“×›×Ÿ ×¢×¡×§×”';
    document.getElementById('editTradeIndicator').classList.add('active');
    document.getElementById('btnCancelEditTrade').style.display = 'inline-flex';

    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-screen="trades"]').classList.add('active');
    document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id === 'screen-trades'));
  }

  document.getElementById('tradeForm').addEventListener('submit', e => {
    e.preventDefault();
    const type = document.getElementById('tradeType').value;
    const symbol = (document.getElementById('tradeSymbol').value || '').trim();
    const qty = Number(document.getElementById('tradeQty').value);
    const price = Number(document.getElementById('tradePrice').value);
    const currency = (document.getElementById('tradeCurrency').value || '').trim() || state.settings.baseCurrency;
    const fee = Number(document.getElementById('tradeFee').value || 0);
    const date = document.getElementById('tradeDate').value;

    if (!symbol || !date || !qty || !price) return;

    if (!currentEditTradeId) {
      state.trades.push({ id: Date.now() + '_' + Math.random().toString(36).slice(2), type, symbol, qty, price, currency, fee, date });
    } else {
      const idx = state.trades.findIndex(t => t.id === currentEditTradeId);
      if (idx >= 0) state.trades[idx] = { id: currentEditTradeId, type, symbol, qty, price, currency, fee, date };
    }

    saveState();
    renderTrades();
    renderPortfolio();
    resetTradeForm();
  });

  document.getElementById('btnCancelEditTrade').addEventListener('click', resetTradeForm);

  document.getElementById('btnClearTrades').addEventListener('click', () => {
    if (confirm('×œ××—×•×§ ××ª ×›×œ ×”×¢×¡×§××•×ª? ×–×” ×‘×œ×ª×™ ×”×¤×™×š.')) {
      state.trades = [];
      saveState();
      renderTrades();
      renderPortfolio();
      resetTradeForm();
    }
  });

  // Dividends manual
  document.getElementById('dividendForm').addEventListener('submit', e => {
    e.preventDefault();
    const symbol = (document.getElementById('divSymbol').value || '').trim();
    const amount = Number(document.getElementById('divAmount').value);
    const currency = (document.getElementById('divCurrency').value || '').trim() || state.settings.baseCurrency;
    const date = document.getElementById('divDate').value;
    if (!symbol || !date || !amount) return;

    state.dividends.push({ id: Date.now() + '_' + Math.random().toString(36).slice(2), symbol, amount, currency, date });
    saveState();
    renderDividends();
    renderPortfolio();
    e.target.reset();
    setDefaultDates();
  });

  document.getElementById('btnClearDividends').addEventListener('click', () => {
    if (confirm('×œ××—×•×§ ××ª ×›×œ ×¨×©×•××•×ª ×”×“×™×‘×™×“× ×“?')) {
      state.dividends = [];
      saveState();
      renderDividends();
      renderPortfolio();
    }
  });

  // Settings
  document.getElementById('btnAddCurrency').addEventListener('click', () => {
    const container = document.getElementById('fxRatesContainer');
    const row = document.createElement('div');
    row.className = 'flex-row';
    row.style.marginBottom = '4px';
    row.innerHTML = `
      <div class="flex-1"><input data-fx-currency placeholder="××˜×‘×¢" /></div>
      <div class="flex-1"><input data-fx-rate type="number" step="0.0001" placeholder="×©×¢×¨" /></div>
    `;
    container.appendChild(row);
  });

  document.getElementById('btnSaveSettings').addEventListener('click', () => {
    const base = (document.getElementById('baseCurrencyInput').value || '').trim() || 'ILS';
    state.settings.baseCurrency = base;

    const fx = {};
    document.querySelectorAll('#fxRatesContainer .flex-row').forEach(r => {
      const c = (r.querySelector('[data-fx-currency]').value || '').trim();
      const rate = Number(r.querySelector('[data-fx-rate]').value);
      if (c && rate > 0) fx[c] = rate;
    });
    fx[base] = 1;
    state.settings.fxRates = fx;

    state.settings.enableOnlineQuotes = !!document.getElementById('enableOnlineQuotes').checked;
    state.settings.alphaVantageKey = (document.getElementById('alphaVantageKey').value || '').trim();

    saveState();
    renderPortfolio();
    alert('×”×”×’×“×¨×•×ª × ×©××¨×•.');
  });

  // Export / Import
  document.getElementById('btnExport').addEventListener('click', () => {
    document.getElementById('exportArea').value = JSON.stringify(state, null, 2);
  });

  document.getElementById('btnImport').addEventListener('click', () => {
    const area = document.getElementById('exportArea');
    try {
      const newState = JSON.parse(area.value);
      if (confirm('×™×™×‘×•× ×™×©×›×ª×‘ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™×. ×œ×”××©×™×š?')) {
        state = newState;
        state.settings = state.settings || {};
        state.lastPrices = state.lastPrices || {};
        saveState();
        renderAll();
        alert('×™×™×‘×•× ×”×¦×œ×™×—.');
      }
    } catch (e) {
      alert('JSON ×œ× ×ª×§×™×Ÿ');
    }
  });

  document.getElementById('btnExportTop').addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-screen="settings"]').classList.add('active');
    document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id === 'screen-settings'));
    document.getElementById('exportArea').value = JSON.stringify(state, null, 2);
  });

  document.getElementById('btnAddInvestmentTop').addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-screen="trades"]').classList.add('active');
    document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id === 'screen-trades'));
  });

  // Helpers
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // Progress helpers
  const progressWrap = document.getElementById('quoteProgressWrap');
  const progressBar = document.getElementById('quoteProgressBar');
  const progressText = document.getElementById('quoteProgressText');
  const progressPct = document.getElementById('quoteProgressPct');
  const btnUpdatePrices = document.getElementById('btnUpdatePrices');

  function progressShow() {
    progressWrap.classList.add('show');
    progressBar.style.width = '0%';
    progressPct.textContent = '0%';
    progressText.textContent = '××ª×—×™×œ ×¢×“×›×•×Ÿâ€¦';
  }
  function progressHide() {
    progressWrap.classList.remove('show');
  }
  function progressSet(done, total, currentSymbol) {
    const pct = total > 0 ? Math.round((done / total) * 100) : 0;
    progressBar.style.width = pct + '%';
    progressPct.textContent = pct + '%';
    progressText.textContent = `××¢×“×›×Ÿ ${done}/${total}: ${currentSymbol || ''}`;
  }

  // ---- Alpha Vantage: FREE endpoint for quotes ----
  async function fetchQuote(symbol) {
    if (!state.settings.enableOnlineQuotes) return { error: 'OFFLINE' };
    const apiKey = state.settings.alphaVantageKey;
    if (!apiKey) return { error: 'NO_KEY' };

    const cleanSymbol = symbol.toUpperCase().trim();
    if (!cleanSymbol) return { error: 'EMPTY' };

    const url =
      'https://www.alphavantage.co/query' +
      '?function=GLOBAL_QUOTE' +
      '&symbol=' + encodeURIComponent(cleanSymbol) +
      '&apikey=' + encodeURIComponent(apiKey);

    try {
      const res = await fetch(url);
      const data = await res.json();

      if (data.Note) return { error: 'RATE_LIMIT', message: data.Note };
      if (data.Information) return { error: 'INFO', message: data.Information };
      if (data['Error Message']) return { error: 'INVALID_SYMBOL', message: data['Error Message'] };

      const quote = data['Global Quote'];
      if (!quote) return { error: 'NO_DATA' };

      const price = parseFloat(quote['05. price']);
      if (!isFinite(price)) return { error: 'BAD_PRICE' };

      return { price, currency: 'USD', asOf: quote['07. latest trading day'] || null };
    } catch (e) {
      return { error: 'NETWORK' };
    }
  }

  btnUpdatePrices.addEventListener('click', async () => {
    const positions = buildPositions();
    if (positions.length === 0) { alert('××™×Ÿ ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª.'); return; }

    if (!state.settings.enableOnlineQuotes) {
      alert('×¢×“×›×•×Ÿ ××—×™×¨×™ ×©×•×§ ××•× ×œ×™×™×Ÿ ×›×‘×•×™.\n×’×© ×œ×”×’×“×¨×•×ª ×•×¡××Ÿ "××¤×©×¨ ×¢×“×›×•×Ÿ ××—×™×¨×™ ×©×•×§ ××•× ×œ×™×™×Ÿ".');
      return;
    }
    if (!state.settings.alphaVantageKey) {
      alert('×œ× ×”×•×’×“×¨ API key ×œ-Alpha Vantage.\n×’×© ×œ×”×’×“×¨×•×ª ×•×”×“×‘×§ ××ª ×”××¤×ª×— ×©×œ×š.');
      return;
    }

    btnUpdatePrices.disabled = true;
    progressShow();

    let updatedCount = 0;
    let failed = [];
    let stopped = false;

    const total = positions.length;

    for (let i = 0; i < total; i++) {
      const p = positions[i];
      const sym = p.symbol.toUpperCase();

      progressSet(i, total, sym);

      // Skip IL numeric symbols (manual)
      if (/^\d{5,}$/.test(sym)) {
        failed.push(sym + ' [IL_MANUAL]');
        continue;
      }

      const result = await fetchQuote(sym);

      if (result?.price) {
        state.lastPrices[sym] = {
          price: result.price,
          currency: result.currency || p.currency,
          updatedAt: new Date().toISOString(),
          source: 'api'
        };
        updatedCount++;
      } else {
        const reason = result?.error || 'UNKNOWN';
        const msg = result?.message ? (' â€” ' + String(result.message).slice(0,120)) : '';
        failed.push(sym + ' [' + reason + ']' + msg);

        if (reason === 'RATE_LIMIT' || reason === 'INFO') {
          stopped = true;
          break;
        }
      }

      // Free tier: 5 calls/min => wait
      if (i < total - 1) await sleep(12500);
    }

    saveState();
    renderPortfolio();

    btnUpdatePrices.disabled = false;
    progressHide();

    alert(
      '×¡×™×•× ×¢×“×›×•×Ÿ ××—×™×¨×™ ×©×•×§.\n' +
      '×¢×•×“×›× ×•: ' + updatedCount + ' × ×™×™×¨×•×ª.\n' +
      (failed.length ? ('×œ× ×¢×•×“×›× ×•: ' + failed.join(', ') + '\n') : '') +
      (stopped ? 'âš ï¸ ×¢×¦×¨×ª×™ ××•×§×“× ×‘×’×œ×œ ×”×•×“×¢×ª ××¢×¨×›×ª/××’×‘×œ×ª ×§×¨×™××•×ª. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×“×§×”.' : '')
    );
  });

  document.getElementById('btnRecalc').addEventListener('click', renderPortfolio);

  // ---- Manual price update ----
  document.getElementById('btnSaveManualPrice').addEventListener('click', () => {
    const sym = normalizeSymbol(document.getElementById('manualPriceSymbol').value);
    const price = Number(document.getElementById('manualPriceValue').value);
    const currency = (document.getElementById('manualPriceCurrency').value || '').trim().toUpperCase() || state.settings.baseCurrency;
    const date = document.getElementById('manualPriceDate').value || new Date().toISOString().slice(0,10);

    if (!sym) { alert('× × ×œ×”×–×™×Ÿ ×¡×™××•×œ / ××¡×¤×¨ × ×™×™×¨.'); return; }
    if (!isFinite(price) || price <= 0) { alert('× × ×œ×”×–×™×Ÿ ××—×™×¨ ×ª×§×™×Ÿ.'); return; }
    if (!currency) { alert('× × ×œ×”×–×™×Ÿ ××˜×‘×¢.'); return; }

    state.lastPrices[sym] = {
      price,
      currency,
      updatedAt: new Date(date + 'T00:00:00').toISOString(),
      source: 'manual'
    };

    saveState();
    renderPortfolio();
    alert('× ×©××¨ ××—×™×¨ ×™×“× ×™ ×¢×‘×•×¨ ' + sym + '.');
  });

  document.getElementById('btnDeleteManualPrice').addEventListener('click', () => {
    const sym = normalizeSymbol(document.getElementById('manualPriceSymbol').value);
    if (!sym) { alert('× × ×œ×”×–×™×Ÿ ×¡×™××•×œ / ××¡×¤×¨ × ×™×™×¨ ×œ××—×™×§×”.'); return; }

    if (!state.lastPrices[sym]) {
      alert('××™×Ÿ ××—×™×¨ ×©××•×¨ ×œ× ×™×™×¨ ' + sym + '.');
      return;
    }

    if (confirm('×œ××—×•×§ ××ª ×”××—×™×¨ ×”×©××•×¨ ×¢×‘×•×¨ ' + sym + '?')) {
      delete state.lastPrices[sym];
      saveState();
      renderPortfolio();
      alert('× ××—×§ ××—×™×¨ ×©××•×¨ ×¢×‘×•×¨ ' + sym + '.');
    }
  });

  // ---- Alpha Vantage: dividends (unchanged) ----
  function getHoldingIntervalsForSymbol(symbol) {
    const clean = symbol.toUpperCase();
    const trades = state.trades.filter(t => normalizeSymbol(t.symbol) === clean).slice().sort((a, b) => a.date.localeCompare(b.date));
    const intervals = [];
    let cumQty = 0;
    let currentStart = null;

    trades.forEach(tr => {
      const signedQty = (tr.type === 'buy' ? 1 : -1) * Number(tr.qty);
      const prevCum = cumQty;
      cumQty += signedQty;

      if (prevCum <= 0 && cumQty > 0) currentStart = tr.date;
      if (prevCum > 0 && cumQty <= 0 && currentStart) {
        intervals.push({ start: currentStart, end: tr.date });
        currentStart = null;
      }
    });

    if (cumQty > 0 && currentStart) intervals.push({ start: currentStart, end: null });
    return intervals;
  }

  function isDateWithinHoldingIntervals(dateStr, intervals) {
    const d = new Date(dateStr);
    return intervals.some(interval => {
      const start = new Date(interval.start);
      const end = interval.end ? new Date(interval.end) : new Date();
      return d >= start && d <= end;
    });
  }

  function getQuantityForSymbolOnDate(symbol, dateStr) {
    const clean = symbol.toUpperCase();
    const cutoff = dateStr;
    let qty = 0;

    state.trades
      .filter(t => normalizeSymbol(t.symbol) === clean && t.date <= cutoff)
      .sort((a, b) => a.date.localeCompare(b.date))
      .forEach(tr => qty += (tr.type === 'buy' ? 1 : -1) * Number(tr.qty));

    return qty;
  }

  async function importDividendsFromAlpha(symbol, yearsBack) {
    if (!state.settings.enableOnlineQuotes) { alert('×™×™×‘×•× ×“×™×‘×™×“× ×“×™× ×“×•×¨×© ×©×¢×“×›×•×Ÿ ××•× ×œ×™×™×Ÿ ×™×”×™×” ×¤×¢×™×œ (××¡×•××Ÿ ×‘×”×’×“×¨×•×ª).'); return 0; }
    const apiKey = state.settings.alphaVantageKey;
    if (!apiKey) { alert('×œ× ××•×’×“×¨ API key ×œ-Alpha Vantage ×‘×”×’×“×¨×•×ª.'); return 0; }

    const cleanSymbol = symbol.toUpperCase().trim();
    if (!cleanSymbol) return 0;

    const holdingIntervals = getHoldingIntervalsForSymbol(cleanSymbol);
    if (holdingIntervals.length === 0) { alert('×œ× × ××¦××• ×¢×¡×§××•×ª ×¢×‘×•×¨ ' + cleanSymbol + ', ×œ×›×Ÿ ××™×Ÿ ×ª×§×•×¤×ª ×”×—×–×§×” ×œ×”×¦×œ×™×‘ ×¢× ×“×™×‘×™×“× ×“×™×.'); return 0; }

    const url =
      'https://www.alphavantage.co/query' +
      '?function=TIME_SERIES_MONTHLY_ADJUSTED' +
      '&symbol=' + encodeURIComponent(cleanSymbol) +
      '&apikey=' + encodeURIComponent(apiKey);

    try {
      const res = await fetch(url);
      if (!res.ok) { alert('×©×’×™××” ×‘×§×¨×™××ª ×“×™×‘×™×“× ×“×™× (status ' + res.status + ').'); return 0; }
      const data = await res.json();

      if (data.Note) { alert('××’×‘×œ×ª ×§×¨×™××•×ª (Alpha Vantage). × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×“×§×”.\n\n' + data.Note); return 0; }
      if (data.Information) { alert('×”×•×“×¢×ª ××¢×¨×›×ª ×-Alpha Vantage:\n\n' + data.Information); return 0; }
      if (data['Error Message']) { alert('×©×’×™××”: ' + data['Error Message']); return 0; }

      const series = data['Monthly Adjusted Time Series'];
      if (!series) { alert('×œ× × ××¦××” ×¡×“×¨×” ×¢×‘×•×¨ ' + cleanSymbol + '.'); return 0; }

      const now = new Date();
      const fromDate = new Date(now.getFullYear() - yearsBack, now.getMonth(), now.getDate());

      const existingKeys = new Set(
        state.dividends
          .filter(d => normalizeSymbol(d.symbol) === cleanSymbol)
          .map(d => cleanSymbol + '|' + d.date + '|' + Number(d.amount).toFixed(6))
      );

      let added = 0;

      Object.entries(series).forEach(([dateStr, values]) => {
        const d = new Date(dateStr);
        if (d < fromDate) return;

        const divPerShare = parseFloat(values['7. dividend amount']);
        if (!isFinite(divPerShare) || divPerShare <= 0) return;

        if (!isDateWithinHoldingIntervals(dateStr, holdingIntervals)) return;

        const qtyHeld = getQuantityForSymbolOnDate(cleanSymbol, dateStr);
        if (qtyHeld <= 0) return;

        const totalAmount = divPerShare * qtyHeld;
        const key = cleanSymbol + '|' + dateStr + '|' + totalAmount.toFixed(6);
        if (existingKeys.has(key)) return;

        state.dividends.push({ id: Date.now() + '_' + Math.random().toString(36).slice(2), symbol: cleanSymbol, amount: totalAmount, currency: 'USD', date: dateStr });
        existingKeys.add(key);
        added++;
      });

      if (added > 0) { saveState(); renderDividends(); renderPortfolio(); }
      return added;
    } catch (e) {
      alert('×©×’×™××” ×‘×§×¨×™××ª ×“×™×‘×™×“× ×“×™× (×¨××” Console).');
      return 0;
    }
  }

  document.getElementById('btnImportDivAlpha').addEventListener('click', async () => {
    const symbol = document.getElementById('importDivSymbolAv').value;
    const yearsBack = Number(document.getElementById('importDivYearsAv').value || '1');
    if (!symbol) { alert('× × ×œ×”×–×™×Ÿ ×¡×™××•×œ (Ticker).'); return; }
    const added = await importDividendsFromAlpha(symbol, yearsBack);
    alert(added === 0
      ? ('×œ× × ××¦××• ×“×™×‘×™×“× ×“×™× ×—×“×©×™× ×œ×™×™×‘×•× ×¢×‘×•×¨ ' + symbol.toUpperCase() + '.')
      : ('×™×•×‘××• ' + added + ' ×“×™×‘×™×“× ×“×™× ×—×“×©×™× ×¢×‘×•×¨ ' + symbol.toUpperCase() + '.')
    );
  });

  function renderAll() { renderPortfolio(); renderTrades(); renderDividends(); renderSettings(); }

  // Init
  loadState();
  setDefaultDates();

  window.addEventListener('load', () => {
    try { renderAll(); }
    catch (e) { console.error(e); showErr('Render error: ' + (e.message || e)); }
  });
})();
</script>

</body>
</html>